<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Connected Persistence Diagram Viewer</title>
  <link rel="icon" type="image/x-icon" href="static/images/favicon.ico">
  <link href="https://fonts.googleapis.com/css?family=Google+Sans|Noto+Sans|Castoro" rel="stylesheet">
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js?config=TeX-AMS-MML_SVG"></script>
  <style>
    /* Minimal reset */
    *, *::before, *::after { box-sizing: border-box; }
    body, h1, h2, p { margin: 0; }
    button, input, select { font: inherit; }

    :root {
      --primary: #2563eb;
      --primary-light: #3b82f6;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-400: #9ca3af;
      --gray-500: #6b7280;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --radius: 8px;
      --radius-sm: 4px;
      --shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
      --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
    }
    body {
      font-family: 'Inter', 'Noto Sans', -apple-system, sans-serif;
      background-color: var(--gray-100);
      color: var(--gray-800);
      font-size: 14px;
      line-height: 1.5;
    }
    /* Subsection */
    .subsection {
      background: var(--gray-50);
      border-radius: var(--radius);
      padding: 16px;
      margin-bottom: 12px;
    }
    .subsection-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--gray-600);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .subsection-title .dot {
      width: 8px;
      height: 8px;
      border-radius: 2px;
    }

    /* Form Controls */
    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 16px;
      align-items: end;
    }
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .form-group label {
      font-size: 11px;
      font-weight: 500;
      color: var(--gray-500);
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }
    .form-group select,
    .form-group input[type="number"] {
      height: 36px;
      padding: 0 12px;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-sm);
      font-size: 13px;
      color: var(--gray-700);
      background: white;
      transition: border-color 0.15s, box-shadow 0.15s;
    }
    .form-group select:focus,
    .form-group input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    .form-group select:disabled {
      background-color: var(--gray-100);
      color: var(--gray-400);
      cursor: not-allowed;
    }
    .form-group input[type="number"] {
      width: 100%;
    }

    /* Name Input */
    .name-input {
      height: 36px;
      padding: 0 12px;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-sm);
      font-size: 13px;
      color: var(--gray-700);
      background: white;
      width: 100%;
      transition: border-color 0.15s, box-shadow 0.15s;
    }
    .name-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    /* Filter Group */
    .filter-group {
      display: flex;
      gap: 4px;
      align-items: center;
    }
    .filter-group input[type="number"] {
      width: 52px;
      text-align: center;
      padding: 0 4px;
      height: 32px;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-sm);
      font-size: 12px;
    }
    .filter-group input[type="number"]::placeholder {
      color: var(--gray-400);
      font-size: 11px;
    }
    .filter-separator {
      color: var(--gray-400);
      font-size: 12px;
      padding: 0 2px;
    }
    .stepper-btn {
      width: 28px;
      height: 28px;
      border: 1px solid var(--gray-300);
      border-radius: var(--radius-sm);
      background: var(--gray-50);
      color: var(--gray-600);
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }
    .stepper-btn:hover {
      background: var(--gray-100);
      border-color: var(--gray-400);
    }
    .stepper-btn:active {
      background: var(--gray-200);
    }
    /* Hide default number input spinners for lifetime inputs */
    #upper-lifetime-min::-webkit-outer-spin-button,
    #upper-lifetime-min::-webkit-inner-spin-button,
    #lower-lifetime-min::-webkit-outer-spin-button,
    #lower-lifetime-min::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    #upper-lifetime-min,
    #lower-lifetime-min {
      -moz-appearance: textfield;
    }

    /* Radio Cards */
    .radio-cards {
      display: flex;
      gap: 12px;
    }
    .radio-card {
      flex: 1;
      position: relative;
    }
    .radio-card input {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }
    .radio-card-content {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border: 2px solid var(--gray-200);
      border-radius: var(--radius);
      background: white;
      transition: all 0.15s;
      cursor: pointer;
    }
    .radio-card input:checked + .radio-card-content {
      border-color: var(--primary);
      background: rgba(37, 99, 235, 0.04);
    }
    .radio-card-content svg {
      flex-shrink: 0;
      color: var(--gray-500);
    }
    .radio-card input:checked + .radio-card-content svg {
      color: var(--primary);
    }
    .radio-card-text {
      font-size: 13px;
      font-weight: 500;
      color: var(--gray-700);
    }
    .radio-card-text small {
      display: block;
      font-size: 11px;
      font-weight: 400;
      color: var(--gray-400);
      margin-top: 2px;
    }

    /* Toggle Switches */
    .toggle-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .toggle {
      position: relative;
      width: 36px;
      height: 20px;
    }
    .toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: var(--gray-300);
      border-radius: 20px;
      transition: 0.2s;
    }
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 14px;
      width: 14px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      border-radius: 50%;
      transition: 0.2s;
      box-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }
    .toggle input:checked + .toggle-slider {
      background-color: var(--primary);
    }
    .toggle input:checked + .toggle-slider:before {
      transform: translateX(16px);
    }
    .toggle-label {
      font-size: 13px;
      color: var(--gray-600);
      cursor: pointer;
    }

    /* Step Buttons */
    .step-label {
      font-size: 11px;
      color: var(--gray-400);
      margin-left: 12px;
    }
    .step-buttons {
      display: flex;
      gap: 4px;
    }
    .step-btn {
      padding: 4px 10px;
      font-size: 12px;
      border: 1px solid var(--gray-200);
      background: white;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.1s;
      color: var(--gray-600);
    }
    .step-btn:hover {
      background: var(--gray-50);
    }
    .step-btn.active {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      font-size: 13px;
      font-weight: 500;
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.15s;
    }
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    .btn-primary:hover {
      background: var(--primary-light);
    }
    .btn-outline {
      background: white;
      border: 1px solid var(--gray-300);
      color: var(--gray-700);
    }
    .btn-outline:hover {
      background: var(--gray-50);
      border-color: var(--gray-400);
    }

    /* Color picker wrapper */
    .color-picker-wrapper {
      background: var(--gray-50);
      border: 1px solid var(--gray-200);
      border-radius: 6px;
      padding: 8px;
    }
    .color-presets-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 4px;
      margin-bottom: 8px;
    }
    .color-preset {
      width: 100%;
      aspect-ratio: 1;
      min-width: 20px;
      border: 2px solid transparent;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.12s;
      padding: 0;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.1);
    }
    .color-preset:hover {
      transform: scale(1.15);
      z-index: 1;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    .color-preset.active {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.3), inset 0 0 0 1px rgba(255,255,255,0.3);
      transform: scale(1.05);
    }
    .color-custom-row {
      display: flex;
      align-items: center;
      gap: 8px;
      padding-top: 8px;
      border-top: 1px solid var(--gray-200);
    }
    .color-custom-label {
      font-size: 11px;
      color: var(--gray-500);
      white-space: nowrap;
    }
    .color-input-small {
      width: 36px;
      height: 36px;
      padding: 2px;
      border: 2px solid transparent;
      border-radius: 4px;
      cursor: pointer;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.1);
    }
    .color-input-small:hover {
      border-color: var(--gray-400);
    }
    .color-hex-display {
      font-size: 12px;
      font-family: monospace;
      color: var(--gray-600);
      background: white;
      padding: 4px 8px;
      border-radius: 4px;
      border: 1px solid var(--gray-200);
    }

    /* ========================================
       SIDEBAR MENU SYSTEM
       ======================================== */
    .app-layout {
      display: flex;
      min-height: calc(100vh - 80px);
      position: relative;
    }

    /* Menu Toggle Button in Header */
    .menu-toggle {
      width: 40px;
      height: 40px;
      border: none;
      background: transparent;
      border-radius: var(--radius);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--gray-500);
      transition: all 0.15s;
      position: relative;
      margin-right: 12px;
    }
    .menu-toggle:hover {
      background: var(--gray-100);
      color: var(--gray-700);
    }
    .menu-toggle.active {
      background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);
      color: white;
    }
    .menu-toggle svg {
      width: 22px;
      height: 22px;
    }

    /* Menu Panel */
    .menu-panel {
      position: fixed;
      left: 0;
      top: 80px;
      width: 340px;
      height: calc(100vh - 80px);
      background: white;
      border-right: 1px solid var(--gray-200);
      box-shadow: var(--shadow-md);
      z-index: 150;
      overflow-y: auto;
      overflow-x: hidden;
      transform: translateX(-100%);
      opacity: 0;
      transition: transform 0.25s ease, opacity 0.2s ease;
      padding: 20px;
    }
    .menu-panel.visible {
      transform: translateX(0);
      opacity: 1;
    }

    .menu-section {
      display: block;
    }

    .menu-section-title {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 12px;
      font-weight: 700;
      color: white;
      margin: 0 -20px 20px -20px;
      padding: 14px 20px 14px 18px;
      background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);
      position: relative;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      box-shadow: 0 2px 6px rgba(59, 130, 246, 0.2);
    }
    .menu-section-title svg {
      width: 16px;
      height: 16px;
      color: rgba(255,255,255,0.9);
      flex-shrink: 0;
    }

    /* Main Content Area */
    .main-content {
      flex: 1;
      margin-left: 0;
      padding: 20px;
      transition: margin-left 0.25s ease;
    }
    .main-content.panel-open {
      margin-left: 340px;
    }

    .plot-wrapper {
      background: white;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px;
      height: calc(100vh - 120px);
      display: flex;
      flex-direction: column;
    }
    .plot-wrapper #plot {
      flex: 1;
      min-height: 0;
    }

    /* Dataset selector in header */
    .dataset-select {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .dataset-select label {
      font-size: 13px;
      color: var(--gray-600);
      font-weight: 500;
    }
    .dataset-select select {
      height: 32px;
      padding: 0 28px 0 10px;
      border: 1px solid var(--gray-300);
      border-radius: var(--radius-sm);
      font-size: 13px;
      background: white;
      cursor: pointer;
    }

    /* Compact form styles for menu panel */
    .menu-panel .form-row {
      grid-template-columns: 1fr;
    }
    .menu-panel .subsection {
      margin-bottom: 16px;
    }
    .menu-panel .radio-cards {
      flex-direction: column;
      gap: 8px;
    }
    .menu-panel .radio-card-content {
      padding: 10px 12px;
    }
    .menu-panel .radio-card-content svg {
      width: 24px;
      height: 24px;
    }
    .menu-panel .toggle-group {
      flex-wrap: wrap;
    }

    /* Stack inline flex rows vertically in menu */
    .menu-panel .form-row {
      display: flex;
      flex-direction: column;
      gap: 12px;
      align-items: stretch;
    }

    /* Left align all menu content - override Bulma */
    .menu-panel,
    .menu-panel * {
      text-align: left !important;
    }
    .menu-panel .form-group {
      align-items: stretch;
      width: 100%;
    }
    .menu-panel .form-group select,
    .menu-panel .form-group input[type="text"],
    .menu-panel .colorscale-dropdown {
      width: 100%;
    }
    .menu-panel .subsection-title {
      justify-content: flex-start;
    }
    .menu-panel .filter-group {
      justify-content: flex-start;
    }
    .menu-panel .filter-group input[type="number"] {
      text-align: center !important;
    }
    .menu-panel input[type="number"][id$="-num"] {
      text-align: center !important;
    }

    /* Section dividers in menu */
    .menu-section + .menu-section {
      margin-top: 28px;
      padding-top: 24px;
      border-top: 2px solid var(--gray-300);
    }

    /* Export buttons in menu */
    .export-section {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .export-section .btn {
      width: 100%;
      justify-content: center;
    }

    /* Custom Colorscale Dropdown */
    .colorscale-dropdown {
      position: relative;
      width: 100%;
    }
    .colorscale-dropdown-trigger {
      display: flex;
      align-items: center;
      gap: 8px;
      height: 36px;
      padding: 0 10px;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-sm);
      background: white;
      cursor: pointer;
      font-size: 13px;
      color: var(--gray-700);
      transition: border-color 0.15s, box-shadow 0.15s;
    }
    .colorscale-dropdown-trigger:hover {
      border-color: var(--gray-300);
    }
    .colorscale-dropdown-trigger:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    .colorscale-dropdown-trigger.disabled {
      background-color: var(--gray-100);
      color: var(--gray-400);
      cursor: not-allowed;
    }
    .colorscale-dropdown-trigger .cs-gradient {
      width: 60px;
      height: 16px;
      border-radius: 3px;
      border: 1px solid var(--gray-300);
      flex-shrink: 0;
    }
    .colorscale-dropdown-trigger .cs-name {
      flex: 1;
      text-align: left;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .colorscale-dropdown-trigger .cs-arrow {
      color: var(--gray-400);
      transition: transform 0.15s;
    }
    .colorscale-dropdown.open .cs-arrow {
      transform: rotate(180deg);
    }
    .colorscale-dropdown-menu {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      margin-top: 4px;
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-sm);
      box-shadow: var(--shadow-md);
      z-index: 100;
      max-height: 450px;
      overflow-y: auto;
      display: none;
    }
    .colorscale-dropdown.open .colorscale-dropdown-menu {
      display: block;
    }
    .colorscale-dropdown-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      cursor: pointer;
      font-size: 13px;
      color: var(--gray-700);
      transition: background 0.1s;
    }
    .colorscale-dropdown-item:hover {
      background: var(--gray-50);
    }
    .colorscale-dropdown-item.selected {
      background: rgba(37, 99, 235, 0.08);
    }
    .colorscale-dropdown-item .cs-gradient {
      width: 80px;
      height: 14px;
      border-radius: 3px;
      border: 1px solid var(--gray-300);
      flex-shrink: 0;
    }
    .colorscale-dropdown-item .cs-name {
      flex: 1;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header style="height: 80px; background: white; border-bottom: 1px solid var(--gray-200); display: flex; align-items: center; padding: 0 24px; position: fixed; top: 0; left: 0; right: 0; z-index: 300;">
    <button class="menu-toggle active" id="menu-toggle" title="Toggle Settings Panel">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
    </button>
    <div style="display: flex; align-items: center; gap: 16px; flex: 1;">
      <h1 style="font-size: 18px; font-weight: 600; color: var(--gray-800); margin: 0;">Connected Persistence Diagram Viewer</h1>
      <span style="color: var(--gray-400);">|</span>
      <div class="dataset-select">
        <label>Dataset:</label>
        <select id="dataset-select">
          <option value="si100">SiO₂ - Si 100% deleted</option>
          <option value="o50">SiO₂ - O 50% deleted</option>
        </select>
      </div>
    </div>
    <a href="./index.html" style="color: var(--gray-500); font-size: 13px; text-decoration: none;">← Back to Homepage</a>
  </header>

  <!-- App Layout -->
  <div class="app-layout" style="padding-top: 80px;">

    <!-- Menu Panel -->
    <div class="menu-panel visible" id="menu-panel">
      <!-- Layout Section -->
      <div class="menu-section" data-section="layout">
        <div class="menu-section-title">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect width="18" height="18" x="3" y="3" rx="2"/><line x1="3" y1="21" x2="21" y2="3"/></svg>
          Layout
        </div>
        <div class="radio-cards">
          <label class="radio-card">
            <input type="radio" name="layout-mode" value="overlapping" checked>
            <div class="radio-card-content">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <rect width="18" height="18" x="3" y="3" rx="2"/>
                <line x1="3" y1="21" x2="21" y2="3"/>
                <circle cx="11" cy="7" r="2" fill="currentColor"/>
                <circle cx="7" cy="12" r="2" fill="currentColor"/>
              </svg>
              <div class="radio-card-text">
                Stacked
                <small>Both diagrams in upper triangle</small>
              </div>
            </div>
          </label>
          <label class="radio-card">
            <input type="radio" name="layout-mode" value="complementary">
            <div class="radio-card-content">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <rect width="18" height="18" x="3" y="3" rx="2"/>
                <line x1="3" y1="21" x2="21" y2="3"/>
                <circle cx="16" cy="14" r="2" fill="currentColor"/>
                <circle cx="7" cy="10" r="2" fill="currentColor"/>
              </svg>
              <div class="radio-card-text">
                Mirrored
                <small>PD₁ transposed to lower triangle</small>
              </div>
            </div>
          </label>
        </div>
      </div>

      <!-- Display Section -->
      <div class="menu-section" data-section="display">
        <div class="menu-section-title">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v2m0 18v2M4.22 4.22l1.42 1.42m12.72 12.72l1.42 1.42M1 12h2m18 0h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
          Display Options
        </div>
        <div style="display: flex; flex-direction: column; gap: 16px;">
          <div class="toggle-group">
            <label class="toggle">
              <input type="checkbox" id="show-grid" checked>
              <span class="toggle-slider"></span>
            </label>
            <span class="toggle-label">Grid</span>
            <span class="step-label" style="margin-left: 16px;">Step:</span>
            <div class="step-buttons" id="grid-step-options" style="margin-left: 8px;">
              <button type="button" class="step-btn" data-step="1">1</button>
              <button type="button" class="step-btn" data-step="2">2</button>
              <button type="button" class="step-btn" data-step="5">5</button>
              <button type="button" class="step-btn active" data-step="10">10</button>
            </div>
          </div>
          <div class="toggle-group">
            <label class="toggle">
              <input type="checkbox" id="show-diagonal" checked>
              <span class="toggle-slider"></span>
            </label>
            <span class="toggle-label">Diagonal Line</span>
          </div>
          <div class="toggle-group">
            <label class="toggle">
              <input type="checkbox" id="show-frame" checked>
              <span class="toggle-slider"></span>
            </label>
            <span class="toggle-label">Frame</span>
          </div>
        </div>
      </div>

      <!-- Labels Section -->
      <div class="menu-section" data-section="labels">
        <div class="menu-section-title">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 7V4h16v3"/><path d="M9 20h6"/><path d="M12 4v16"/></svg>
          Labels
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Plot Title</label>
            <input type="text" id="plot-title" value="Connected Persistence Diagram" class="name-input" placeholder="Plot title">
          </div>
        </div>
        <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
          <div class="form-group">
            <label>Top</label>
            <input type="text" id="label-top" value="" class="name-input" placeholder="Top label">
          </div>
          <div class="form-group">
            <label>Bottom</label>
            <input type="text" id="label-bottom" value="" class="name-input" placeholder="Bottom label">
          </div>
          <div class="form-group">
            <label>Left</label>
            <input type="text" id="label-left" value="" class="name-input" placeholder="Left label">
          </div>
          <div class="form-group">
            <label>Right</label>
            <input type="text" id="label-right" value="" class="name-input" placeholder="Right label">
          </div>
        </div>
      </div>

      <!-- Points Section -->
      <div class="menu-section" data-section="points">
        <div class="menu-section-title">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="4"/><circle cx="4" cy="4" r="2"/><circle cx="20" cy="20" r="2"/></svg>
          Points
        </div>

        <!-- Global Point Settings -->
        <div style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 16px;">
          <div class="form-group">
            <label>Size</label>
            <div style="display: flex; gap: 6px; align-items: center;">
              <input type="range" id="point-size" min="3" max="20" value="8" style="flex: 1;">
              <span id="point-size-value" style="min-width: 20px; text-align: center; font-size: 13px;">8</span>
            </div>
          </div>
          <div style="display: flex; flex-direction: column; gap: 12px;">
            <div class="toggle-group">
              <label class="toggle">
                <input type="checkbox" id="same-colorscale">
                <span class="toggle-slider"></span>
              </label>
              <span class="toggle-label">Same color scale</span>
            </div>
            <div class="colorscale-dropdown" id="shared-colorscale-dropdown" data-value="YlOrRd" data-disabled="true" style="width: 100%;">
              <div class="colorscale-dropdown-trigger disabled" tabindex="0">
                <div class="cs-gradient"></div>
                <span class="cs-name">YlOrRd</span>
                <svg class="cs-arrow" width="12" height="12" viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 4.5L6 7.5L9 4.5"/></svg>
              </div>
              <div class="colorscale-dropdown-menu"></div>
            </div>
          </div>
        </div>

        <!-- Upper Diagram -->
        <div class="subsection">
          <div class="subsection-title">
            <span class="dot" style="background: #1e40af;"></span>
            Upper Diagram (D₂)
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Name</label>
              <input type="text" id="upper-name" value="$D_2$" class="name-input" placeholder="$D_2$">
            </div>
            <div class="form-group">
              <label>Shape</label>
              <select id="upper-shape-select">
                <option value="square">Square</option>
                <option value="circle">Circle</option>
                <option value="diamond">Diamond</option>
                <option value="cross">Cross</option>
                <option value="x">X Mark</option>
                <option value="triangle-up">Triangle ▲</option>
                <option value="triangle-down">Triangle ▼</option>
                <option value="star">Star ★</option>
              </select>
            </div>
            <div class="form-group individual-colorscale">
              <label>Color Scale</label>
              <div class="colorscale-dropdown" id="upper-colorscale-dropdown" data-value="YlGnBu">
                <div class="colorscale-dropdown-trigger" tabindex="0">
                  <div class="cs-gradient"></div>
                  <span class="cs-name">YlGnBu</span>
                  <svg class="cs-arrow" width="12" height="12" viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 4.5L6 7.5L9 4.5"/></svg>
                </div>
                <div class="colorscale-dropdown-menu"></div>
              </div>
            </div>
            <div class="form-group">
              <label>Opacity</label>
              <div style="display: flex; gap: 6px; align-items: center;">
                <input type="range" id="upper-opacity" min="0" max="1" step="0.01" value="1" style="flex: 1;">
                <input type="number" id="upper-opacity-num" min="0" max="1" step="0.01" value="1.00" style="width: 50px; height: 28px; padding: 0 4px; font-size: 12px; text-align: center; border: 1px solid var(--gray-200); border-radius: 4px;">
              </div>
            </div>
            <div class="form-group">
              <label>Filter (multiplicity)</label>
              <div class="filter-group">
                <input type="number" id="upper-filter-min" placeholder="−∞">
                <span class="filter-separator">~</span>
                <input type="number" id="upper-filter-max" placeholder="+∞">
              </div>
            </div>
            <div class="form-group">
              <label>Min Lifetime</label>
              <div style="display: flex; align-items: center; gap: 4px;">
                <button type="button" class="stepper-btn" data-target="upper-lifetime-min" data-delta="-1">−</button>
                <input type="number" id="upper-lifetime-min" placeholder="0" min="0" style="width: 50px; text-align: center;">
                <button type="button" class="stepper-btn" data-target="upper-lifetime-min" data-delta="1">+</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Lower Diagram -->
        <div class="subsection">
          <div class="subsection-title">
            <span class="dot" style="background: #dc2626;"></span>
            Lower Diagram (D₁)
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Name</label>
              <input type="text" id="lower-name" value="$D_1$" class="name-input" placeholder="$D_1$">
            </div>
            <div class="form-group">
              <label>Shape</label>
              <select id="lower-shape-select">
                <option value="square">Square</option>
                <option value="circle">Circle</option>
                <option value="diamond">Diamond</option>
                <option value="cross">Cross</option>
                <option value="x">X Mark</option>
                <option value="triangle-up">Triangle ▲</option>
                <option value="triangle-down">Triangle ▼</option>
                <option value="star">Star ★</option>
              </select>
            </div>
            <div class="form-group individual-colorscale">
              <label>Color Scale</label>
              <div class="colorscale-dropdown" id="lower-colorscale-dropdown" data-value="YlOrRd">
                <div class="colorscale-dropdown-trigger" tabindex="0">
                  <div class="cs-gradient"></div>
                  <span class="cs-name">YlOrRd</span>
                  <svg class="cs-arrow" width="12" height="12" viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 4.5L6 7.5L9 4.5"/></svg>
                </div>
                <div class="colorscale-dropdown-menu"></div>
              </div>
            </div>
            <div class="form-group">
              <label>Opacity</label>
              <div style="display: flex; gap: 6px; align-items: center;">
                <input type="range" id="lower-opacity" min="0" max="1" step="0.01" value="1" style="flex: 1;">
                <input type="number" id="lower-opacity-num" min="0" max="1" step="0.01" value="1.00" style="width: 50px; height: 28px; padding: 0 4px; font-size: 12px; text-align: center; border: 1px solid var(--gray-200); border-radius: 4px;">
              </div>
            </div>
            <div class="form-group">
              <label>Filter (multiplicity)</label>
              <div class="filter-group">
                <input type="number" id="lower-filter-min" placeholder="−∞">
                <span class="filter-separator">~</span>
                <input type="number" id="lower-filter-max" placeholder="+∞">
              </div>
            </div>
            <div class="form-group">
              <label>Min Lifetime</label>
              <div style="display: flex; align-items: center; gap: 4px;">
                <button type="button" class="stepper-btn" data-target="lower-lifetime-min" data-delta="-1">−</button>
                <input type="number" id="lower-lifetime-min" placeholder="0" min="0" style="width: 50px; text-align: center;">
                <button type="button" class="stepper-btn" data-target="lower-lifetime-min" data-delta="1">+</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Connections Section -->
      <div class="menu-section" data-section="connections">
        <div class="menu-section-title">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 20L20 4"/><circle cx="4" cy="20" r="2"/><circle cx="20" cy="4" r="2"/></svg>
          Connections
        </div>

        <div class="form-row" style="margin-bottom: 16px;">
          <div class="form-group">
            <label>Name</label>
            <input type="text" id="line-name" value="Connections" class="name-input" placeholder="Connections">
          </div>
          <div class="form-group">
            <label>Filter (multiplicity)</label>
            <div class="filter-group">
              <input type="number" id="line-filter-min" placeholder="−∞">
              <span class="filter-separator">~</span>
              <input type="number" id="line-filter-max" placeholder="+∞">
            </div>
          </div>
        </div>

        <div class="form-group" style="margin-bottom: 16px;">
          <label>Color Mode</label>
          <div style="display: flex; gap: 16px; align-items: center; margin-top: 6px;">
            <label style="display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 13px; text-transform: none; font-weight: 400; color: var(--gray-700);">
              <input type="radio" name="line-color-mode" value="scale" checked style="accent-color: var(--primary);">
              By Multiplicity
            </label>
            <label style="display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 13px; text-transform: none; font-weight: 400; color: var(--gray-700);">
              <input type="radio" name="line-color-mode" value="single" style="accent-color: var(--primary);">
              Single
            </label>
          </div>
        </div>

        <div class="form-row" style="margin-bottom: 16px;">
          <div class="form-group" id="line-single-color-group" style="flex: 1.5; display: none;">
            <label>Color</label>
            <div class="color-picker-wrapper">
              <div class="color-presets-grid">
                <!-- Grayscale row -->
                <button type="button" class="color-preset" data-color="#000000" style="background: #000000;" title="Black"></button>
                <button type="button" class="color-preset" data-color="#374151" style="background: #374151;" title="Slate"></button>
                <button type="button" class="color-preset" data-color="#6b7280" style="background: #6b7280;" title="Gray"></button>
                <button type="button" class="color-preset active" data-color="#9ca3af" style="background: #9ca3af;" title="Cool Gray"></button>
                <button type="button" class="color-preset" data-color="#d1d5db" style="background: #d1d5db;" title="Light Gray"></button>
                <button type="button" class="color-preset" data-color="#f3f4f6" style="background: #f3f4f6; box-shadow: inset 0 0 0 1px rgba(0,0,0,0.15);" title="Off White"></button>
                <!-- Data viz categorical (bold, accessible) -->
                <button type="button" class="color-preset" data-color="#e60049" style="background: #e60049;" title="Red"></button>
                <button type="button" class="color-preset" data-color="#0bb4ff" style="background: #0bb4ff;" title="Sky Blue"></button>
                <button type="button" class="color-preset" data-color="#50e991" style="background: #50e991;" title="Mint"></button>
                <button type="button" class="color-preset" data-color="#e6d800" style="background: #e6d800;" title="Yellow"></button>
                <button type="button" class="color-preset" data-color="#9b19f5" style="background: #9b19f5;" title="Purple"></button>
                <button type="button" class="color-preset" data-color="#ffa300" style="background: #ffa300;" title="Orange"></button>
                <!-- Deeper tones (professional) -->
                <button type="button" class="color-preset" data-color="#1984c5" style="background: #1984c5;" title="Steel Blue"></button>
                <button type="button" class="color-preset" data-color="#c23728" style="background: #c23728;" title="Crimson"></button>
                <button type="button" class="color-preset" data-color="#22a7f0" style="background: #22a7f0;" title="Azure"></button>
                <button type="button" class="color-preset" data-color="#54bebe" style="background: #54bebe;" title="Teal"></button>
                <button type="button" class="color-preset" data-color="#dc0ab4" style="background: #dc0ab4;" title="Magenta"></button>
                <button type="button" class="color-preset" data-color="#00bfa0" style="background: #00bfa0;" title="Emerald"></button>
              </div>
              <div class="color-custom-row">
                <span class="color-custom-label">Custom:</span>
                <input type="color" id="line-single-color" value="#9ca3af" class="color-input-small">
                <span class="color-hex-display" id="color-hex-display">#9CA3AF</span>
              </div>
            </div>
          </div>
          <div class="form-group" id="line-colorscale-group">
            <label>Color Scale</label>
            <div class="colorscale-dropdown" id="line-colorscale-dropdown" data-value="Greys">
              <div class="colorscale-dropdown-trigger" tabindex="0">
                <div class="cs-gradient"></div>
                <span class="cs-name">Greys</span>
                <svg class="cs-arrow" width="12" height="12" viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 4.5L6 7.5L9 4.5"/></svg>
              </div>
              <div class="colorscale-dropdown-menu"></div>
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Width</label>
            <div style="display: flex; gap: 6px; align-items: center;">
              <input type="range" id="line-width" min="0.1" max="3" step="0.1" value="0.8" style="flex: 1;">
              <input type="number" id="line-width-num" min="0.1" max="3" step="0.1" value="0.8" style="width: 50px; height: 28px; padding: 0 4px; font-size: 12px; text-align: center; border: 1px solid var(--gray-200); border-radius: 4px;">
            </div>
          </div>
          <div class="form-group">
            <label>Opacity</label>
            <div style="display: flex; gap: 6px; align-items: center;">
              <input type="range" id="line-opacity" min="0" max="1" step="0.01" value="0.60" style="flex: 1;">
              <input type="number" id="line-opacity-num" min="0" max="1" step="0.01" value="0.60" style="width: 50px; height: 28px; padding: 0 4px; font-size: 12px; text-align: center; border: 1px solid var(--gray-200); border-radius: 4px;">
            </div>
          </div>
        </div>
      </div>

      <!-- Export Section -->
      <div class="menu-section" data-section="export">
        <div class="menu-section-title">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>
          Export
        </div>
        <div class="export-section">
          <button class="btn btn-outline" onclick="exportSVG()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>
            Export as SVG
          </button>
          <button class="btn btn-primary" onclick="exportPNG()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>
            Export as PNG
          </button>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <main class="main-content panel-open" id="main-content">
      <div class="plot-wrapper">
        <div id="plot"></div>
      </div>
    </main>
  </div>

  <script src="./cpd-data.js"></script>
  <script>
    // Current data
    let currentData = null;

    // Initialize data
    function initData() {
      currentData = getDataByName('si100');
    }

    // Get data by name
    function getDataByName(name) {
      if (window.CPD_DATA) {
        if (name === 'si100') return window.CPD_DATA.SI100;
        if (name === 'o50') return window.CPD_DATA.O50;
      }
      return null;
    }

    // ============================================
    // Parse data into visualization format
    // ============================================
    function parseData(data) {
      const couplings = []; // Lines connecting points

      // Track UPPER (D2) and LOWER (D1) points separately
      // In connected persistence diagrams:
      // - D2 (upper): second point in coupling tuple (c,d)
      // - D1 (lower): first point in coupling tuple (a,b)
      const upperPointMap = new Map();  // key: "x,y", value: count
      const lowerPointMap = new Map();  // key: "x,y", value: count

      // Helper to add/update a point in a specific map
      function addToMap(map, x, y, count) {
        const key = `${x},${y}`;
        map.set(key, (map.get(key) || 0) + Math.abs(count));
      }

      for (const [key, value] of Object.entries(data.dec)) {
        const parts = key.split(',').map(Number);

        if (parts[0] === data.len && parts[1] === -1) {
          // Single persistence point: "len,-1,birth,death"
          // These are uncoupled points - assign to lower (D1) as they represent
          // the standard persistence diagram
          const x = parts[2], y = parts[3];
          addToMap(lowerPointMap, x, y, value);
        } else if (parts.length === 4 && value !== 0) {
          // Connected points: "a,b,c,d" connects (a,b) to (c,d)
          // Format: first point (a,b) is D1 (lower), second point (c,d) is D2 (upper)
          const a = parts[0], b = parts[1], c = parts[2], d = parts[3];

          // Add first point to D1 (lower)
          addToMap(lowerPointMap, a, b, Math.abs(value));
          // Add second point to D2 (upper)
          addToMap(upperPointMap, c, d, Math.abs(value));

          // Check if this is NOT a self-coupling
          if (!(a === c && b === d)) {
            // Line from D1 point (a,b) to D2 point (c,d)
            couplings.push({
              x1: a, y1: b,  // D1 point (lower/first)
              x2: c, y2: d,  // D2 point (upper/second)
              weight: value
            });
          }
        }
      }

      // Convert point maps to arrays
      const pdUpper = [];
      for (const [key, count] of upperPointMap) {
        const [x, y] = key.split(',').map(Number);
        pdUpper.push({ x, y, count });
      }

      const pdLower = [];
      for (const [key, count] of lowerPointMap) {
        const [x, y] = key.split(',').map(Number);
        pdLower.push({ x, y, count });
      }

      return { pdUpper, pdLower, couplings, len: data.len };
    }

    // ============================================
    // Convert simple LaTeX to Unicode for tooltips
    // ============================================
    function latexToUnicode(text) {
      if (!text) return text;

      // Subscript mapping
      const subscripts = {
        '0': '₀', '1': '₁', '2': '₂', '3': '₃', '4': '₄',
        '5': '₅', '6': '₆', '7': '₇', '8': '₈', '9': '₉',
        'a': 'ₐ', 'e': 'ₑ', 'h': 'ₕ', 'i': 'ᵢ', 'j': 'ⱼ',
        'k': 'ₖ', 'l': 'ₗ', 'm': 'ₘ', 'n': 'ₙ', 'o': 'ₒ',
        'p': 'ₚ', 'r': 'ᵣ', 's': 'ₛ', 't': 'ₜ', 'u': 'ᵤ',
        'v': 'ᵥ', 'x': 'ₓ'
      };

      // Superscript mapping
      const superscripts = {
        '0': '⁰', '1': '¹', '2': '²', '3': '³', '4': '⁴',
        '5': '⁵', '6': '⁶', '7': '⁷', '8': '⁸', '9': '⁹',
        'a': 'ᵃ', 'b': 'ᵇ', 'c': 'ᶜ', 'd': 'ᵈ', 'e': 'ᵉ',
        'f': 'ᶠ', 'g': 'ᵍ', 'h': 'ʰ', 'i': 'ⁱ', 'j': 'ʲ',
        'k': 'ᵏ', 'l': 'ˡ', 'm': 'ᵐ', 'n': 'ⁿ', 'o': 'ᵒ',
        'p': 'ᵖ', 'r': 'ʳ', 's': 'ˢ', 't': 'ᵗ', 'u': 'ᵘ',
        'v': 'ᵛ', 'w': 'ʷ', 'x': 'ˣ', 'y': 'ʸ', 'z': 'ᶻ',
        '+': '⁺', '-': '⁻'
      };

      // Remove $ delimiters
      let result = text.replace(/^\$|\$$/g, '');

      // Convert subscripts: _x or _{xx}
      result = result.replace(/_\{([^}]+)\}/g, (match, content) => {
        return content.split('').map(c => subscripts[c] || c).join('');
      });
      result = result.replace(/_([a-z0-9])/gi, (match, char) => {
        return subscripts[char.toLowerCase()] || char;
      });

      // Convert superscripts: ^x or ^{xx}
      result = result.replace(/\^\{([^}]+)\}/g, (match, content) => {
        return content.split('').map(c => superscripts[c] || c).join('');
      });
      result = result.replace(/\^([a-z0-9+-])/gi, (match, char) => {
        return superscripts[char.toLowerCase()] || char;
      });

      return result;
    }

    // ============================================
    // Filter helper function
    // ============================================
    function passesFilter(count, filter) {
      const { min, max } = filter;
      // Empty/null means no limit (infinity)
      const passesMin = min === null || count >= min;
      const passesMax = max === null || count <= max;
      return passesMin && passesMax;
    }

    // ============================================
    // Colorscale gradients for previews
    // ============================================
    // Official Plotly.js colorscales: https://plotly.com/javascript/colorscales/
    const COLORSCALE_GRADIENTS = {
      'YlOrRd': 'linear-gradient(to right, #800026, #bd0026, #fc4e2a, #feb24c, #fed976, #ffffcc)',
      'YlGnBu': 'linear-gradient(to right, #081d58, #253494, #1d91c0, #7fcdbb, #c7e9b4, #ffffd9)',
      'RdBu': 'linear-gradient(to right, #050aac, #6a89f7, #bebebe, #e69a5a, #b20a1c)',
      'Portland': 'linear-gradient(to right, #0c3383, #0a88ba, #f2d338, #f28f38, #d91e1e)',
      'Picnic': 'linear-gradient(to right, #0000ff, #66ccff, #ffffff, #ff99ff, #ff0000)',
      'Jet': 'linear-gradient(to right, #000083, #003caa, #05ffff, #ffff00, #fa0000, #800000)',
      'Hot': 'linear-gradient(to right, #000000, #e60000, #ffd200, #ffffff)',
      'Greys': 'linear-gradient(to right, #000000, #ffffff)',
      'Greens': 'linear-gradient(to right, #00441b, #006d2c, #74c476, #c7e9c0, #f7fcf5)',
      'Electric': 'linear-gradient(to right, #000000, #1e0064, #780064, #a05a00, #e6c800, #fffadc)',
      'Earth': 'linear-gradient(to right, #000082, #00b4b4, #28d228, #e6e632, #784614, #ffffff)',
      'Bluered': 'linear-gradient(to right, #0000ff, #ff0000)',
      'Blackbody': 'linear-gradient(to right, #000000, #e60000, #e6d200, #ffffff, #a0c8ff)'
    };

    // ============================================
    // Custom Colorscale Dropdown
    // ============================================
    const COLORSCALE_OPTIONS = [
      'YlOrRd', 'YlGnBu', 'RdBu', 'Portland', 'Picnic',
      'Jet', 'Hot', 'Greys', 'Greens',
      'Electric', 'Earth', 'Bluered', 'Blackbody'
    ];

    function initColorscaleDropdown(dropdownId) {
      const dropdown = document.getElementById(dropdownId);
      if (!dropdown) return;

      const trigger = dropdown.querySelector('.colorscale-dropdown-trigger');
      const menu = dropdown.querySelector('.colorscale-dropdown-menu');
      const gradientEl = trigger.querySelector('.cs-gradient');
      const nameEl = trigger.querySelector('.cs-name');
      const currentValue = dropdown.dataset.value || 'YlOrRd';

      // Update trigger display
      function updateTrigger(value) {
        dropdown.dataset.value = value;
        nameEl.textContent = value;
        gradientEl.style.background = COLORSCALE_GRADIENTS[value] || COLORSCALE_GRADIENTS['YlOrRd'];
      }

      // Populate menu
      menu.innerHTML = '';
      COLORSCALE_OPTIONS.forEach(name => {
        const item = document.createElement('div');
        item.className = 'colorscale-dropdown-item' + (name === currentValue ? ' selected' : '');
        item.dataset.value = name;
        item.innerHTML = `
          <div class="cs-gradient" style="background: ${COLORSCALE_GRADIENTS[name]}"></div>
          <span class="cs-name">${name}</span>
        `;
        item.addEventListener('click', function(e) {
          e.stopPropagation();
          const val = this.dataset.value;
          // Update selection
          menu.querySelectorAll('.colorscale-dropdown-item').forEach(i => i.classList.remove('selected'));
          this.classList.add('selected');
          updateTrigger(val);
          dropdown.classList.remove('open');
          updatePlot();
        });
        menu.appendChild(item);
      });

      // Set initial trigger display
      updateTrigger(currentValue);

      // Toggle dropdown on trigger click
      trigger.addEventListener('click', function(e) {
        if (dropdown.dataset.disabled === 'true') return;
        e.stopPropagation();
        // Close other dropdowns
        document.querySelectorAll('.colorscale-dropdown.open').forEach(d => {
          if (d !== dropdown) d.classList.remove('open');
        });
        dropdown.classList.toggle('open');
      });

      // Keyboard support
      trigger.addEventListener('keydown', function(e) {
        if (dropdown.dataset.disabled === 'true') return;
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          trigger.click();
        }
      });
    }

    function setDropdownDisabled(dropdownId, disabled) {
      const dropdown = document.getElementById(dropdownId);
      if (!dropdown) return;
      const trigger = dropdown.querySelector('.colorscale-dropdown-trigger');
      dropdown.dataset.disabled = disabled ? 'true' : 'false';
      if (disabled) {
        trigger.classList.add('disabled');
        dropdown.classList.remove('open');
      } else {
        trigger.classList.remove('disabled');
      }
    }

    function getDropdownValue(dropdownId) {
      const dropdown = document.getElementById(dropdownId);
      return dropdown ? dropdown.dataset.value : 'YlOrRd';
    }

    function initAllColorscaleDropdowns() {
      initColorscaleDropdown('shared-colorscale-dropdown');
      initColorscaleDropdown('upper-colorscale-dropdown');
      initColorscaleDropdown('lower-colorscale-dropdown');
      initColorscaleDropdown('line-colorscale-dropdown');

      // Close dropdowns when clicking outside
      document.addEventListener('click', function() {
        document.querySelectorAll('.colorscale-dropdown.open').forEach(d => d.classList.remove('open'));
      });
    }

    // ============================================
    // Create Plotly traces
    // ============================================
    function createTraces(parsedData, options) {
      const traces = [];
      const { pdUpper, pdLower, couplings, len } = parsedData;
      const { layout, upperName, lowerName, lineName, upperColorscale, lowerColorscale, sameColorscale, upperFilter, lowerFilter, lineColorMode, lineSingleColor, lineColorscale, lineFilter, upperLifetimeMin, lowerLifetimeMin, pointSize, upperOpacity, lowerOpacity, upperShape, lowerShape, lineOpacity, lineWidth, showDiagonal } = options;

      const isComplementary = layout === 'complementary';

      // Add diagonal line
      if (showDiagonal) {
        traces.push({
          x: [0, len],
          y: [0, len],
          mode: 'lines',
          line: { color: '#333', width: 1.5 },
          hoverinfo: 'skip',
          showlegend: false
        });
      }

      // Add coupling lines
      if (couplings.length > 0) {
        // Filter couplings by multiplicity filter (using raw value, can be negative)
        const filteredCouplings = couplings.filter(c => passesFilter(c.weight, lineFilter));

        // Prepare hover points for connections (midpoints of lines)
        const hoverX = [];
        const hoverY = [];
        const hoverText = [];
        const lineNameDisplay = latexToUnicode(lineName);
        const upperNameDisplay = latexToUnicode(upperName);
        const lowerNameDisplay = latexToUnicode(lowerName);

        if (lineColorMode === 'single' && filteredCouplings.length > 0) {
          // Single color mode - use color picker value
          // Convert hex to rgba with opacity
          const hex = lineSingleColor;
          const r = parseInt(hex.slice(1, 3), 16);
          const g = parseInt(hex.slice(3, 5), 16);
          const b = parseInt(hex.slice(5, 7), 16);
          const color = `rgba(${r}, ${g}, ${b}, ${lineOpacity})`;

          // All couplings combined
          const lineX = [];
          const lineY = [];
          for (const c of filteredCouplings) {
            let x1 = c.x1, y1 = c.y1;
            let x2 = c.x2, y2 = c.y2;
            if (isComplementary) {
              [x1, y1] = [y1, x1];
            }
            lineX.push(x1, x2, null);
            lineY.push(y1, y2, null);

            // Add hover point at midpoint
            hoverX.push((x1 + x2) / 2);
            hoverY.push((y1 + y2) / 2);
            hoverText.push(`${lineNameDisplay}<br>${upperNameDisplay}: (${c.x2}, ${c.y2})<br>${lowerNameDisplay}: (${c.x1}, ${c.y1})<br>Multiplicity: ${c.weight}`);
          }

          if (lineX.length > 0) {
            traces.push({
              x: lineX,
              y: lineY,
              mode: 'lines',
              line: { color: color, width: lineWidth },
              hoverinfo: 'skip',
              showlegend: true,
              name: lineName
            });
          }
        } else if (lineColorMode === 'scale' && filteredCouplings.length > 0) {
          // Color scheme mode - color lines by weight/multiplicity
          const schemeName = lineColorscale;
          const weights = filteredCouplings.map(c => c.weight);
          const minWeight = Math.min(...weights);
          const maxWeight = Math.max(...weights);
          const weightRange = maxWeight - minWeight;

          // Group all lines by raw weight for efficient rendering
          const weightGroups = new Map();
          for (const c of filteredCouplings) {
            const w = c.weight;
            if (!weightGroups.has(w)) {
              weightGroups.set(w, []);
            }
            weightGroups.get(w).push(c);
          }

          // Create color interpolation function based on scheme
          // Official Plotly.js colorscales: https://plotly.com/javascript/colorscales/
          function getSchemeColor(normalizedValue, scheme) {
            const schemes = {
              'YlOrRd': [[128,0,38], [189,0,38], [252,78,42], [254,178,76], [255,237,160], [255,255,204]],
              'YlGnBu': [[8,29,88], [37,52,148], [29,145,192], [127,205,187], [199,233,180], [255,255,217]],
              'RdBu': [[5,10,172], [106,137,247], [190,190,190], [220,170,132], [178,10,28]],
              'Portland': [[12,51,131], [10,136,186], [242,211,56], [242,143,56], [217,30,30]],
              'Picnic': [[0,0,255], [102,204,255], [255,255,255], [255,153,255], [255,0,0]],
              'Jet': [[0,0,131], [0,60,170], [5,255,255], [255,255,0], [250,0,0], [128,0,0]],
              'Hot': [[0,0,0], [230,0,0], [255,210,0], [255,255,255]],
              'Greys': [[0,0,0], [255,255,255]],
              'Greens': [[0,68,27], [0,109,44], [116,196,118], [199,233,192], [247,252,245]],
              'Electric': [[0,0,0], [30,0,100], [120,0,100], [160,90,0], [230,200,0], [255,250,220]],
              'Earth': [[0,0,130], [0,180,180], [40,210,40], [230,230,50], [120,70,20], [255,255,255]],
              'Bluered': [[0,0,255], [255,0,0]],
              'Blackbody': [[0,0,0], [230,0,0], [230,210,0], [255,255,255], [160,200,255]]
            };
            const stops = schemes[scheme] || schemes['YlOrRd'];
            const idx = normalizedValue * (stops.length - 1);
            const low = Math.floor(idx);
            const high = Math.min(Math.ceil(idx), stops.length - 1);
            const t = idx - low;
            const r = Math.round(stops[low][0] * (1-t) + stops[high][0] * t);
            const g = Math.round(stops[low][1] * (1-t) + stops[high][1] * t);
            const b = Math.round(stops[low][2] * (1-t) + stops[high][2] * t);
            return [r, g, b];
          }

          // Add traces for each weight group
          let firstTrace = true;
          const sortedWeights = Array.from(weightGroups.keys()).sort((a, b) => a - b);

          for (const weight of sortedWeights) {
            const group = weightGroups.get(weight);
            const lineX = [];
            const lineY = [];

            for (const c of group) {
              let x1 = c.x1, y1 = c.y1;
              let x2 = c.x2, y2 = c.y2;

              if (isComplementary) {
                [x1, y1] = [y1, x1];
              }

              lineX.push(x1, x2, null);
              lineY.push(y1, y2, null);

              // Add hover point at midpoint
              hoverX.push((x1 + x2) / 2);
              hoverY.push((y1 + y2) / 2);
              hoverText.push(`${lineNameDisplay}<br>${upperNameDisplay}: (${c.x2}, ${c.y2})<br>${lowerNameDisplay}: (${c.x1}, ${c.y1})<br>Multiplicity: ${c.weight}`);
            }

            // Normalize weight to 0-1 range based on min/max
            const normalizedWeight = weightRange > 0 ? (weight - minWeight) / weightRange : 0.5;
            const [r, g, b] = getSchemeColor(normalizedWeight, schemeName);
            const color = `rgba(${r}, ${g}, ${b}, ${lineOpacity})`;

            traces.push({
              x: lineX,
              y: lineY,
              mode: 'lines',
              line: { color: color, width: lineWidth },
              hoverinfo: 'skip',
              showlegend: firstTrace,
              legendgroup: 'connections',
              name: firstTrace ? lineName : ''
            });
            firstTrace = false;
          }
        }

        // Add invisible hover points for connections
        if (hoverX.length > 0) {
          traces.push({
            x: hoverX,
            y: hoverY,
            mode: 'markers',
            marker: {
              size: 10,
              color: 'rgba(0,0,0,0)',
              line: { width: 0 }
            },
            text: hoverText,
            hoverinfo: 'text',
            showlegend: false
          });
        }
      }

      // Add UPPER persistence diagram points (always in upper-left triangle)
      // Filter by both multiplicity and lifetime (death - birth)
      const filteredUpper = pdUpper.filter(p => passesFilter(p.count, upperFilter) && (p.y - p.x) >= upperLifetimeMin);
      const filteredLower = pdLower.filter(p => passesFilter(p.count, lowerFilter) && (p.y - p.x) >= lowerLifetimeMin);

      // Calculate combined max for shared colorscale
      const maxFilteredUpperCount = filteredUpper.length > 0 ? Math.max(...filteredUpper.map(p => p.count), 1) : 1;
      const maxFilteredLowerCount = filteredLower.length > 0 ? Math.max(...filteredLower.map(p => p.count), 1) : 1;
      const combinedMax = Math.max(maxFilteredUpperCount, maxFilteredLowerCount);

      if (filteredUpper.length > 0) {
        const colorbarConfig = sameColorscale ? {
          title: 'Multiplicity',
          titleside: 'right',
          thickness: 12,
          len: 0.8,
          x: 0.82,
          y: 0.5,
          xanchor: 'left',
          tickfont: { size: 9 }
        } : {
          title: upperName,
          titleside: 'right',
          thickness: 12,
          len: 0.8,
          x: 0.82,
          y: 0.5,
          xanchor: 'left',
          tickfont: { size: 9 }
        };

        traces.push({
          type: 'scatter',
          x: filteredUpper.map(p => p.x),
          y: filteredUpper.map(p => p.y),
          mode: 'markers',
          marker: {
            size: pointSize,
            opacity: upperOpacity,
            color: filteredUpper.map(p => p.count),
            colorscale: upperColorscale,
            cmin: 1,
            cmax: sameColorscale ? combinedMax : maxFilteredUpperCount,
            colorbar: colorbarConfig,
            symbol: upperShape
          },
          text: filteredUpper.map(p => `${latexToUnicode(upperName)}<br>Birth: ${p.x}<br>Death: ${p.y}<br>Count: ${p.count}`),
          hoverinfo: 'text',
          showlegend: true,
          name: upperName
        });
      }

      // Add LOWER persistence diagram points
      if (filteredLower.length > 0) {
        let lowerX, lowerY;

        if (isComplementary) {
          // Mirror to lower-right triangle (swap x and y)
          lowerX = filteredLower.map(p => p.y);
          lowerY = filteredLower.map(p => p.x);
        } else {
          // Overlapping - same position as original
          lowerX = filteredLower.map(p => p.x);
          lowerY = filteredLower.map(p => p.y);
        }

        const lowerMarkerConfig = {
          size: pointSize,
          opacity: lowerOpacity,
          color: filteredLower.map(p => p.count),
          colorscale: lowerColorscale,
          cmin: 1,
          cmax: sameColorscale ? combinedMax : maxFilteredLowerCount,
          symbol: lowerShape
        };

        // Only show colorbar for lower if not using shared colorscale
        if (!sameColorscale) {
          lowerMarkerConfig.colorbar = {
            title: lowerName,
            titleside: 'right',
            thickness: 12,
            len: 0.8,
            x: 0.89,
            y: 0.5,
            xanchor: 'left',
            tickfont: { size: 9 }
          };
        }

        traces.push({
          type: 'scatter',
          x: lowerX,
          y: lowerY,
          mode: 'markers',
          marker: lowerMarkerConfig,
          text: filteredLower.map(p => `${latexToUnicode(lowerName)}<br>Birth: ${p.x}<br>Death: ${p.y}<br>Count: ${p.count}`),
          hoverinfo: 'text',
          showlegend: true,
          name: lowerName
        });
      }

      // Add Connections colorbar when using a color scheme
      if (lineColorMode === 'scale' && couplings.length > 0) {
        const colorbarFilteredCouplings = couplings.filter(c => passesFilter(c.weight, lineFilter));
        if (colorbarFilteredCouplings.length > 0) {
          const colorbarWeights = colorbarFilteredCouplings.map(c => c.weight);
          const minWeight = Math.min(...colorbarWeights);
          const maxWeight = Math.max(...colorbarWeights);
          const schemeName = lineColorscale;

          // Position colorbar based on how many point colorbars are shown
          const connectionsColorbarX = sameColorscale ? 0.89 : 0.96;

          // Add invisible trace for the colorbar
          traces.push({
            x: [null],
            y: [null],
            mode: 'markers',
            marker: {
              size: 0,
              color: [minWeight, maxWeight],
              colorscale: schemeName,
              cmin: minWeight,
              cmax: maxWeight,
              colorbar: {
                title: lineName,
                titleside: 'right',
                thickness: 12,
                len: 0.8,
                x: connectionsColorbarX,
                y: 0.5,
                xanchor: 'left',
                tickfont: { size: 9 }
              }
            },
            hoverinfo: 'skip',
            showlegend: false
          });
        }
      }

      return traces;
    }

    // ============================================
    // Export filename helper
    // ============================================
    const DATASET_NAMES = {
      'si100': 'SiO2_Si-all-removed',
      'o50': 'SiO2_O-half-removed'
    };

    function getExportFilename() {
      const datasetEl = document.getElementById('dataset-select');
      const layoutRadio = document.querySelector('input[name="layout-mode"]:checked');
      const showGrid = document.getElementById('show-grid')?.checked;
      const gridStep = document.querySelector('.step-btn.active')?.dataset.step || '10';
      const showFrame = document.getElementById('show-frame')?.checked;
      const upperLifetime = parseFloat(document.getElementById('upper-lifetime-min').value) || 0;
      const lowerLifetime = parseFloat(document.getElementById('lower-lifetime-min').value) || 0;

      const dataset = datasetEl ? datasetEl.value : 'si100';
      const layoutValue = layoutRadio ? layoutRadio.value : 'overlapping';
      const layoutName = layoutValue === 'complementary' ? 'mirrored' : 'stacked';
      const datasetName = DATASET_NAMES[dataset] || dataset;
      const gridPart = showGrid ? `grid${gridStep}` : 'nogrid';
      const framePart = showFrame ? 'frame' : 'noframe';
      const lifetimePart = (upperLifetime > 0 || lowerLifetime > 0)
        ? `_lifetime-D2ge${upperLifetime}-D1ge${lowerLifetime}`
        : '';

      return `cPD_${datasetName}_${layoutName}_${gridPart}_${framePart}${lifetimePart}`;
    }

    // ============================================
    // Update plot
    // ============================================
    function updatePlot() {
      if (!currentData) {
        console.error('No data loaded');
        return;
      }

      // Get filter settings (empty = no limit / infinity)
      const getFilter = (prefix) => {
        const minInput = document.getElementById(`${prefix}-filter-min`).value;
        const maxInput = document.getElementById(`${prefix}-filter-max`).value;
        const min = minInput === '' ? null : parseFloat(minInput);
        const max = maxInput === '' ? null : parseFloat(maxInput);
        return { min, max };
      };

      const sameColorscale = document.getElementById('same-colorscale').checked;
      const sharedColorscale = getDropdownValue('shared-colorscale-dropdown');

      const options = {
        layout: document.querySelector('input[name="layout-mode"]:checked').value,
        upperName: document.getElementById('upper-name').value || '$D_2$',
        lowerName: document.getElementById('lower-name').value || '$D_1$',
        lineName: document.getElementById('line-name').value || 'Connections',
        upperColorscale: sameColorscale ? sharedColorscale : getDropdownValue('upper-colorscale-dropdown'),
        lowerColorscale: sameColorscale ? sharedColorscale : getDropdownValue('lower-colorscale-dropdown'),
        sameColorscale: sameColorscale,
        upperFilter: getFilter('upper'),
        lowerFilter: getFilter('lower'),
        lineColorMode: document.querySelector('input[name="line-color-mode"]:checked').value,
        lineSingleColor: document.getElementById('line-single-color').value,
        lineColorscale: getDropdownValue('line-colorscale-dropdown'),
        lineFilter: getFilter('line'),
        upperLifetimeMin: parseFloat(document.getElementById('upper-lifetime-min').value) || 0,
        lowerLifetimeMin: parseFloat(document.getElementById('lower-lifetime-min').value) || 0,
        pointSize: parseInt(document.getElementById('point-size').value),
        upperOpacity: parseFloat(document.getElementById('upper-opacity').value),
        lowerOpacity: parseFloat(document.getElementById('lower-opacity').value),
        upperShape: document.getElementById('upper-shape-select').value,
        lowerShape: document.getElementById('lower-shape-select').value,
        lineOpacity: parseFloat(document.getElementById('line-opacity').value),
        lineWidth: parseFloat(document.getElementById('line-width').value),
        showGrid: document.getElementById('show-grid').checked,
        showDiagonal: document.getElementById('show-diagonal').checked,
        showFrame: document.getElementById('show-frame').checked,
        gridStep: parseInt(document.querySelector('.step-btn.active')?.dataset.step) || 10,
        plotTitle: document.getElementById('plot-title').value,
        labelTop: document.getElementById('label-top').value,
        labelBottom: document.getElementById('label-bottom').value,
        labelLeft: document.getElementById('label-left').value,
        labelRight: document.getElementById('label-right').value
      };

      const parsedData = parseData(currentData);
      const traces = createTraces(parsedData, options);

      const plotLayout = {
        title: {
          text: options.plotTitle,
          font: { size: 18 },
          x: 0.45,
          y: 0.99,
          xanchor: 'center',
          yanchor: 'top',
        },
        xaxis: {
          range: [0, currentData.len],
          autorange: false,
          constrain: 'domain',
          showgrid: options.showGrid,
          gridcolor: '#ccc',
          zeroline: false,
          scaleanchor: 'y',
          scaleratio: 1,
          showticklabels: options.showGrid,
          ticks: options.showGrid ? 'outside' : '',
          dtick: options.gridStep,
          tick0: 0,
          showline: options.showFrame,
          linecolor: '#333',
          linewidth: 1,
          mirror: options.showFrame,
          fixedrange: true,
          domain: [0, 0.88]
        },
        yaxis: {
          range: [0, currentData.len],
          autorange: false,
          constrain: 'domain',
          showgrid: options.showGrid,
          gridcolor: '#ccc',
          zeroline: false,
          showticklabels: options.showGrid,
          ticks: options.showGrid ? 'outside' : '',
          dtick: options.gridStep,
          tick0: 0,
          showline: options.showFrame,
          linecolor: '#333',
          linewidth: 1,
          mirror: options.showFrame,
          fixedrange: true
        },
        hovermode: 'closest',
        showlegend: true,
        legend: {
          x: 0.63,
          y: 1.02,
          xanchor: 'center',
          yanchor: 'bottom',
          orientation: 'h'
        },
        annotations: [
          // Top label
          options.labelTop && {
            text: options.labelTop,
            x: 0.44,
            y: 1.01,
            xref: 'paper',
            yref: 'paper',
            xanchor: 'center',
            yanchor: 'bottom',
            showarrow: false,
            font: { size: 14 }
          },
          // Bottom label
          options.labelBottom && {
            text: options.labelBottom,
            x: 0.44,
            y: -0.02,
            xref: 'paper',
            yref: 'paper',
            xanchor: 'center',
            yanchor: 'top',
            showarrow: false,
            font: { size: 14 }
          },
          // Left label
          options.labelLeft && {
            text: options.labelLeft,
            x: 0.16,
            y: 0.5,
            xref: 'paper',
            yref: 'paper',
            xanchor: 'center',
            yanchor: 'middle',
            textangle: -90,
            showarrow: false,
            font: { size: 14 }
          },
          // Right label
          options.labelRight && {
            text: options.labelRight,
            x: 0.72,
            y: 0.5,
            xref: 'paper',
            yref: 'paper',
            xanchor: 'center',
            yanchor: 'middle',
            textangle: 90,
            showarrow: false,
            font: { size: 14 }
          },
          // Lifetime filter info (under colorbar area)
          (options.upperLifetimeMin > 0 || options.lowerLifetimeMin > 0) && {
            text: [
              options.upperLifetimeMin > 0 ? `${latexToUnicode(options.upperName)} lifetime≥${options.upperLifetimeMin}` : '',
              options.lowerLifetimeMin > 0 ? `${latexToUnicode(options.lowerName)} lifetime≥${options.lowerLifetimeMin}` : ''
            ].filter(Boolean).join('<br>'),
            x: 0.88,
            y: 0.08,
            xref: 'paper',
            yref: 'paper',
            xanchor: 'center',
            yanchor: 'top',
            showarrow: false,
            font: { size: 10, color: '#666' }
          }
        ].filter(Boolean),
        margin: { l: 60, r: 40, t: 80, b: 50 },
        plot_bgcolor: 'white',
        paper_bgcolor: 'white'
      };

      const plotEl = document.getElementById('plot');
      const config = {
        responsive: true,
        toImageButtonOptions: {
          format: 'svg',
          filename: getExportFilename(),
          height: plotEl ? plotEl.offsetHeight : 800,
          width: plotEl ? plotEl.offsetWidth : 800,
          scale: 2
        }
      };

      Plotly.newPlot('plot', traces, plotLayout, config);
    }

    // ============================================
    // Export functions
    // ============================================
    function getPlotDimensions() {
      const plotEl = document.getElementById('plot');
      return {
        width: plotEl.offsetWidth || 800,
        height: plotEl.offsetHeight || 800
      };
    }

    function exportSVG() {
      const dims = getPlotDimensions();
      Plotly.downloadImage('plot', {
        format: 'svg',
        filename: getExportFilename(),
        height: dims.height,
        width: dims.width
      });
    }

    function exportPNG() {
      const dims = getPlotDimensions();
      Plotly.downloadImage('plot', {
        format: 'png',
        filename: getExportFilename(),
        height: dims.height,
        width: dims.width,
        scale: 2
      });
    }

    // ============================================
    // Menu Panel System
    // ============================================
    let isPinned = true; // Default: pinned (visible)
    let hideTimeout = null;
    const HIDE_DELAY = 300; // ms delay before hiding menu

    function showMenu() {
      const menuPanel = document.getElementById('menu-panel');
      const mainContent = document.getElementById('main-content');
      const menuToggle = document.getElementById('menu-toggle');

      if (hideTimeout) {
        clearTimeout(hideTimeout);
        hideTimeout = null;
      }

      menuPanel.classList.add('visible');
      mainContent.classList.add('panel-open');
      menuToggle.classList.add('active');
    }

    function hideMenu() {
      if (isPinned) return;

      hideTimeout = setTimeout(() => {
        const menuPanel = document.getElementById('menu-panel');
        const mainContent = document.getElementById('main-content');
        const menuToggle = document.getElementById('menu-toggle');

        menuPanel.classList.remove('visible');
        mainContent.classList.remove('panel-open');
        menuToggle.classList.remove('active');
      }, HIDE_DELAY);
    }

    function togglePin() {
      const menuToggle = document.getElementById('menu-toggle');
      const menuPanel = document.getElementById('menu-panel');
      const mainContent = document.getElementById('main-content');

      isPinned = !isPinned;

      if (isPinned) {
        menuToggle.classList.add('active');
        menuPanel.classList.add('visible');
        mainContent.classList.add('panel-open');
      } else {
        // When unpinning, start hiding
        hideMenu();
      }
    }

    function initMenuToggle() {
      const menuToggle = document.getElementById('menu-toggle');
      const menuPanel = document.getElementById('menu-panel');

      // Click to toggle pin
      menuToggle.addEventListener('click', togglePin);

      // Hover to show (when not pinned)
      menuToggle.addEventListener('mouseenter', () => {
        if (!isPinned) {
          showMenu();
        }
      });

      menuToggle.addEventListener('mouseleave', () => {
        if (!isPinned) {
          hideMenu();
        }
      });

      // Keep menu open when hovering over panel
      menuPanel.addEventListener('mouseenter', () => {
        if (hideTimeout) {
          clearTimeout(hideTimeout);
          hideTimeout = null;
        }
      });

      menuPanel.addEventListener('mouseleave', () => {
        if (!isPinned) {
          hideMenu();
        }
      });

      // Initialize default state (pinned = visible)
      if (isPinned) {
        showMenu();
      }
    }

    // ============================================
    // Event listeners
    // ============================================
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize menu toggle
      initMenuToggle();

      // Dataset selection dropdown
      document.getElementById('dataset-select').addEventListener('change', function() {
        currentData = getDataByName(this.value);
        updatePlot();
      });

      // Slider value display and real-time update
      document.getElementById('point-size').addEventListener('input', function() {
        document.getElementById('point-size-value').textContent = this.value;
        updatePlot();
      });

      // Upper opacity - sync slider and number input
      document.getElementById('upper-opacity').addEventListener('input', function() {
        document.getElementById('upper-opacity-num').value = parseFloat(this.value).toFixed(2);
        updatePlot();
      });
      document.getElementById('upper-opacity-num').addEventListener('input', function() {
        const val = Math.max(0, Math.min(1, parseFloat(this.value) || 1));
        document.getElementById('upper-opacity').value = val;
        this.value = val.toFixed(2);
        updatePlot();
      });

      // Lower opacity - sync slider and number input
      document.getElementById('lower-opacity').addEventListener('input', function() {
        document.getElementById('lower-opacity-num').value = parseFloat(this.value).toFixed(2);
        updatePlot();
      });
      document.getElementById('lower-opacity-num').addEventListener('input', function() {
        const val = Math.max(0, Math.min(1, parseFloat(this.value) || 1));
        document.getElementById('lower-opacity').value = val;
        this.value = val.toFixed(2);
        updatePlot();
      });

      // Line opacity - sync slider and number input
      document.getElementById('line-opacity').addEventListener('input', function() {
        document.getElementById('line-opacity-num').value = parseFloat(this.value).toFixed(2);
        updatePlot();
      });
      document.getElementById('line-opacity-num').addEventListener('input', function() {
        const val = Math.max(0, Math.min(1, parseFloat(this.value) || 0.6));
        document.getElementById('line-opacity').value = val;
        this.value = val.toFixed(2);
        updatePlot();
      });

      // Line width - sync slider and number input
      document.getElementById('line-width').addEventListener('input', function() {
        document.getElementById('line-width-num').value = parseFloat(this.value).toFixed(1);
        updatePlot();
      });
      document.getElementById('line-width-num').addEventListener('input', function() {
        const val = Math.max(0.1, Math.min(3, parseFloat(this.value) || 0.8));
        document.getElementById('line-width').value = val;
        this.value = val.toFixed(1);
        updatePlot();
      });

      // Auto-update on control changes
      ['line-single-color', 'show-diagonal', 'show-frame', 'upper-shape-select', 'lower-shape-select'].forEach(id => {
        document.getElementById(id).addEventListener('change', updatePlot);
        // Also listen for input event on color picker for real-time updates
        if (id === 'line-single-color') {
          document.getElementById(id).addEventListener('input', updatePlot);
        }
      });

      // Line color mode radio buttons
      document.querySelectorAll('input[name="line-color-mode"]').forEach(radio => {
        radio.addEventListener('change', function() {
          const isSingle = this.value === 'single';
          document.getElementById('line-single-color-group').style.display = isSingle ? '' : 'none';
          document.getElementById('line-colorscale-group').style.display = isSingle ? 'none' : '';
          updatePlot();
        });
      });

      // Same colorscale toggle - disable/enable instead of hide/show
      document.getElementById('same-colorscale').addEventListener('change', function() {
        const sameColorscale = this.checked;
        // Enable shared colorscale when toggle is on
        setDropdownDisabled('shared-colorscale-dropdown', !sameColorscale);
        // Disable individual colorscales when toggle is on
        setDropdownDisabled('upper-colorscale-dropdown', sameColorscale);
        setDropdownDisabled('lower-colorscale-dropdown', sameColorscale);
        updatePlot();
      });

      // Layout mode radio buttons
      document.querySelectorAll('input[name="layout-mode"]').forEach(radio => {
        radio.addEventListener('change', updatePlot);
      });

      // Filter range inputs
      ['upper-filter-min', 'upper-filter-max', 'lower-filter-min', 'lower-filter-max', 'line-filter-min', 'line-filter-max', 'upper-lifetime-min', 'lower-lifetime-min'].forEach(id => {
        document.getElementById(id).addEventListener('input', updatePlot);
      });

      // Name inputs
      ['upper-name', 'lower-name', 'line-name'].forEach(id => {
        document.getElementById(id).addEventListener('input', updatePlot);
      });

      // Label inputs (title, axis labels)
      ['plot-title', 'label-top', 'label-bottom', 'label-left', 'label-right'].forEach(id => {
        document.getElementById(id).addEventListener('input', updatePlot);
      });

      // Show grid checkbox - toggle step buttons state
      document.getElementById('show-grid').addEventListener('change', function() {
        const disabled = !this.checked;
        document.querySelectorAll('.step-btn').forEach(btn => {
          btn.disabled = disabled;
        });
        document.getElementById('grid-step-options').style.opacity = disabled ? '0.5' : '1';
        updatePlot();
      });

      // Grid step buttons
      document.querySelectorAll('.step-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.step-btn').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          updatePlot();
        });
      });

      // Lifetime stepper buttons
      document.querySelectorAll('.stepper-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const targetId = this.dataset.target;
          const delta = parseInt(this.dataset.delta);
          const input = document.getElementById(targetId);
          const currentVal = parseFloat(input.value) || 0;
          const newVal = Math.max(0, currentVal + delta);
          input.value = newVal;
          updatePlot();
        });
      });

      // Color preset buttons
      document.querySelectorAll('.color-preset').forEach(btn => {
        btn.addEventListener('click', function() {
          const color = this.dataset.color;
          const colorInput = document.getElementById('line-single-color');
          const hexDisplay = document.getElementById('color-hex-display');
          colorInput.value = color;
          hexDisplay.textContent = color.toUpperCase();
          // Update active state
          document.querySelectorAll('.color-preset').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          updatePlot();
        });
      });

      // Sync preset active state and hex display when color picker changes
      document.getElementById('line-single-color').addEventListener('input', function() {
        const currentColor = this.value.toLowerCase();
        const hexDisplay = document.getElementById('color-hex-display');
        hexDisplay.textContent = this.value.toUpperCase();
        document.querySelectorAll('.color-preset').forEach(btn => {
          btn.classList.toggle('active', btn.dataset.color.toLowerCase() === currentColor);
        });
      });

      // Initialize custom colorscale dropdowns
      initAllColorscaleDropdowns();

      // Initialize data and render
      initData();
      updatePlot();
    });
  </script>
</body>
</html>
